# ==============================================================================
# SCRIPT DE AUTOMA√á√ÉO DE GOVERNAN√áA (TAGS + POLICIES) VIA PLANILHA
# ==============================================================================

# 1. Configura√ß√µes Iniciais
$CSVPath = "C:\..."
$PolicyId = "cd3aa116-8754-49c9-a813-ad46512ece54"
$PolicyDisplayName = "Inherit a tag from the resource group if missing"

# Importa os dados usando o delimitador ';' conforme seu arquivo
Write-Host "üìÇ Carregando dados da planilha..." -ForegroundColor Cyan
try {
    $Data = Import-Csv -Path $CSVPath -Delimiter ";"
} catch {
    Write-Error "‚ùå Erro ao ler o arquivo CSV. Verifique se o caminho est√° correto."
    exit
}

$CurrentSub = ""

# 2. Loop de Processamento
foreach ($Row in $Data) {
    # Pula linhas vazias se houver
    if ([string]::IsNullOrWhiteSpace($Row.NAME)) { continue }

    $RgName = $Row.NAME
    $Subscription = $Row.SUBSCRIPTION
    $RgLocation = $Row.LOCATION
    
    Write-Host "`n" + ("=" * 60) -ForegroundColor Gray
    Write-Host "üì¶ RECURSO: $RgName" -ForegroundColor Cyan -NoNewline
    Write-Host " (Assinatura: $Subscription)" -ForegroundColor DarkGray

    # 3. Troca de Assinatura Autom√°tica
    if ($CurrentSub -ne $Subscription) {
        Write-Host "üîÑ Trocando contexto para assinatura..." -ForegroundColor Yellow
        az account set --subscription $Subscription
        if ($LASTEXITCODE -ne 0) { 
            Write-Error "‚ùå Falha ao acessar assinatura $Subscription. Pulando este item."
            continue 
        }
        $CurrentSub = $Subscription
    }

    # 4. Mapeamento das Tags (Conforme os nomes das colunas da sua planilha)
    $Tags = @{
        "environment" = $Row.'TAG - environment'
        "cost-center" = $Row.'TAG - cost-center'
        "application" = $Row.'TAG - application'
        "cost-owner"  = $Row.'TAG - cost-owner'
    }

    $Scope = "/subscriptions/$(az account show --query id -o tsv)/resourceGroups/$RgName"

    # 5. Aplica√ß√£o de Tags no Resource Group
    Write-Host "‚û°Ô∏è Aplicando tags no RG..." -ForegroundColor Green
    foreach ($Tag in $Tags.GetEnumerator()) {
        if (-not [string]::IsNullOrWhiteSpace($Tag.Value)) {
            az group update -n $RgName --set "tags.$($Tag.Key)=$($Tag.Value)" | Out-Null
        }
    }

    # 6. Cria√ß√£o de Assignments e Remedia√ß√µes (Loop para as 4 tags)
    foreach ($Tag in $Tags.GetEnumerator()) {
        $Key = $Tag.Key
        if ([string]::IsNullOrWhiteSpace($Tag.Value)) { continue }

        # Limita o nome para n√£o estourar os 64 caracteres do Azure
        $ShortRg = if ($RgName.Length -gt 25) { $RgName.Substring(0,25) } else { $RgName }
        $AssignmentName = "inh-$Key-$($ShortRg.Replace(' ','-'))"
        $RemediationName = "rem-$Key-$($ShortRg.Replace(' ','-'))"

        Write-Host "üèóÔ∏è Configurando Pol√≠tica [$Key]..." -ForegroundColor DarkYellow

        # Criar JSON de par√¢metros tempor√°rio (TagName)
        $Params = @{ tagName = @{ value = $Key } } | ConvertTo-Json -Compress
        $TempFile = [System.IO.Path]::GetTempFileName()
        $Params | Out-File $TempFile -Encoding UTF8

        # Executa a cria√ß√£o do Assignment
        $Assignment = az policy assignment create `
            --name $AssignmentName `
            --display-name "$PolicyDisplayName - $Key" `
            --scope $Scope `
            --policy $PolicyId `
            --params $TempFile `
            --assign-identity `
            --identity-scope $Scope `
            --role Contributor `
            --location $RgLocation

        Remove-Item $TempFile -Force

        # Se o Assignment foi criado (ou j√° existia), dispara a Remedia√ß√£o
        if ($LASTEXITCODE -eq 0) {
            Write-Host "   ‚úÖ Assignment OK. Disparando remedia√ß√£o..." -ForegroundColor Green
            az policy remediation create `
                --name $RemediationName `
                --resource-group $RgName `
                --policy-assignment $AssignmentName `
                --resource-discovery-mode ReEvaluateCompliance | Out-Null
        } else {
            Write-Warning "   ‚ö†Ô∏è Falha ao criar assignment para a tag $Key."
        }
    }
}

Write-Host "`n" + ("=" * 60)
Write-Host "‚úÖ SUCESSO: Processamento da planilha conclu√≠do!" -ForegroundColor Cyan
